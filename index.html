<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>贪吃蛇</title>
<style>
    :root {
        --bg-color: #1e1e2f;
        --grid-color: #333;
        --snake-color: #4caf50;
        --snake-head-color: #ff5722;
        --food-color: #f44336;
        --text-color: #fff;
        --btn-bg: #3a3a5e;
        --btn-hover: #5a5a8f;
    }

    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        min-height: 100vh;
        padding: 20px;
    }

    h1 {
        margin-bottom: 10px;
    }

    canvas {
        background-color: #111;
        border: 2px solid var(--grid-color);
        touch-action: none;
    }

    #controls {
        margin-top: 10px;
        display: flex;
        gap: 10px;
    }

    button {
        padding: 10px 20px;
        background-color: var(--btn-bg);
        border: none;
        color: var(--text-color);
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s;
    }

    button:hover {
        background-color: var(--btn-hover);
    }

    #scoreboard {
        margin-top: 10px;
    }

    #instructions {
        margin-top: 15px;
        text-align: center;
        font-size: 14px;
        color: #bbb;
        max-width: 400px;
    }
</style>
</head>
<body>
<h1>贪吃蛇</h1>
<canvas id="gameCanvas" width="400" height="400"></canvas>
<div id="scoreboard">
    分数: <span id="score">0</span> | 最高分: <span id="highScore">0</span>
</div>
<div id="controls">
    <button id="startBtn">开始</button>
    <button id="pauseBtn">暂停</button>
    <button id="resetBtn">重置</button>
</div>
<div id="instructions">
    点击画布或使用屏幕上下左右滑动控制方向。<br>
    开始按钮启动游戏，暂停按钮暂停，重置按钮重新开始。
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const gridSize = 20; // 逻辑格子大小
const cellCount = canvas.width / gridSize;

let snake = [{x: 5, y: 5}];
let snakeDir = {x: 1, y: 0};
let nextDir = {x: 1, y: 0};
let food = {};
let score = 0;
let highScore = localStorage.getItem('snakeHighScore') || 0;
let gameInterval = null;
let gameSpeed = 60; // fps
let isRunning = false;
let isGameOver = false;

function placeFood() {
    let newFood;
    do {
        newFood = {
            x: Math.floor(Math.random() * cellCount),
            y: Math.floor(Math.random() * cellCount)
        };
    } while(snake.some(s => s.x === newFood.x && s.y === newFood.y));
    food = newFood;
}

function drawGrid() {
    ctx.strokeStyle = '#333';
    for (let i = 0; i <= cellCount; i++) {
        ctx.beginPath();
        ctx.moveTo(i*gridSize, 0);
        ctx.lineTo(i*gridSize, canvas.height);
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(0, i*gridSize);
        ctx.lineTo(canvas.width, i*gridSize);
        ctx.stroke();
    }
}

function draw() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawGrid();

    // draw food
    ctx.fillStyle = 'var(--food-color)';
    ctx.fillRect(food.x*gridSize, food.y*gridSize, gridSize, gridSize);

    // draw snake
    snake.forEach((seg, index) => {
        ctx.fillStyle = index===0 ? 'var(--snake-head-color)' : 'var(--snake-color)';
        ctx.fillRect(seg.x*gridSize, seg.y*gridSize, gridSize, gridSize);
    });
}

function update() {
    if(isGameOver) return;

    snakeDir = nextDir;

    let newHead = {
        x: snake[0].x + snakeDir.x,
        y: snake[0].y + snakeDir.y
    };

    // 检查碰撞
    if(newHead.x < 0 || newHead.y < 0 || newHead.x >= cellCount || newHead.y >= cellCount ||
       snake.some(s => s.x === newHead.x && s.y === newHead.y)) {
        isGameOver = true;
        isRunning = false;
        clearInterval(gameInterval);
        draw(); // 最后一帧停留蛇头位置
        alert('游戏结束！');
        return;
    }

    snake.unshift(newHead);

    // 吃食物
    if(newHead.x === food.x && newHead.y === food.y) {
        score++;
        if(score > highScore) {
            highScore = score;
            localStorage.setItem('snakeHighScore', highScore);
            document.getElementById('highScore').innerText = highScore;
        }
        placeFood();
    } else {
        snake.pop();
    }

    draw();
}

function startGame() {
    if(isRunning) return;
    if(isGameOver) {
        resetGame();
    }
    isRunning = true;
    gameInterval = setInterval(update, 1000/gameSpeed);
}

function pauseGame() {
    isRunning = false;
    clearInterval(gameInterval);
}

function resetGame() {
    snake = [{x: 5, y: 5}];
    snakeDir = {x: 1, y: 0};
    nextDir = {x: 1, y: 0};
    score = 0;
    isGameOver = false;
    document.getElementById('score').innerText = score;
    placeFood();
    draw();
}

function handleKey(e) {
    if(isGameOver) return;
    switch(e.key) {
        case 'ArrowUp': if(snakeDir.y===0){nextDir={x:0,y:-1}} break;
        case 'ArrowDown': if(snakeDir.y===0){nextDir={x:0,y:1}} break;
        case 'ArrowLeft': if(snakeDir.x===0){nextDir={x:-1,y:0}} break;
        case 'ArrowRight': if(snakeDir.x===0){nextDir={x:1,y:0}} break;
    }
}

function handleTouchStart(e) {
    if(isGameOver) return;
    const touch = e.touches[0];
    startX = touch.clientX;
    startY = touch.clientY;
}

function handleTouchMove(e) {
    if(isGameOver) return;
    if(!startX || !startY) return;
    const touch = e.touches[0];
    const dx = touch.clientX - startX;
    const dy = touch.clientY - startY;
    if(Math.abs(dx) > Math.abs(dy)) {
        if(dx>0 && snakeDir.x===0) nextDir={x:1,y:0};
        else if(dx<0 && snakeDir.x===0) nextDir={x:-1,y:0};
    } else {
        if(dy>0 && snakeDir.y===0) nextDir={x:0,y:1};
        else if(dy<0 && snakeDir.y===0) nextDir={x:0,y:-1};
    }
    startX=null;
    startY=null;
    e.preventDefault();
}

document.addEventListener('keydown', handleKey);
canvas.addEventListener('touchstart', handleTouchStart);
canvas.addEventListener('touchmove', handleTouchMove);

document.getElementById('startBtn').addEventListener('click', startGame);
document.getElementById('pauseBtn').addEventListener('click', pauseGame);
document.getElementById('resetBtn').addEventListener('click', resetGame);

// 初始化
resetGame();
</script>
</body>
</html>
